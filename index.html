<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" />
<title>PlantillaBox ‚Äî Espacio Creativo</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<style>
  :root {
    /* Paleta Premium Dark Deep */
    --bg-deep: #050507;
    --bg-surface: #0e0e11;
    --card-bg: rgba(20, 20, 25, 0.6);
    --card-border: rgba(255, 255, 255, 0.08);
    
    /* Acentos Refinados */
    --primary: #2dd4bf;       /* Teal */
    --primary-glow: rgba(45, 212, 191, 0.25);
    --secondary: #6366f1;     /* Indigo */
    --accent-gradient: linear-gradient(135deg, #2dd4bf 0%, #3b82f6 50%, #6366f1 100%);
    --gold: #fbbf24;          /* Para el candado */
    
    /* Utilidades */
    --muted: #94a3b8;
    --text-main: #f8fafc;
    --danger: #f43f5e;
    --glass-border: 1px solid rgba(255, 255, 255, 0.06);
    
    /* Animaciones */
    --ease-elastic: cubic-bezier(0.175, 0.885, 0.32, 1.275);
    --ease-smooth: cubic-bezier(0.25, 0.1, 0.25, 1);
    --trans-med: 300ms var(--ease-smooth);
  }

  * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
  
  html, body { height: 100%; }
  
  body {
    margin: 0;
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
    background-color: var(--bg-deep);
    /* Fondo sutil y elegante */
    background-image: 
        radial-gradient(circle at 10% 20%, rgba(45, 212, 191, 0.04), transparent 40%),
        radial-gradient(circle at 90% 80%, rgba(99, 102, 241, 0.06), transparent 40%);
    background-attachment: fixed;
    color: var(--text-main);
    min-height: 100vh;
    padding-bottom: 80px;
  }

  /* Scrollbar est√©tico */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
  ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.25); }

  /* HEADER Cristal */
  header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 18px 28px;
    position: sticky; top: 0;
    background: rgba(5, 5, 7, 0.85);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border-bottom: 1px solid rgba(255,255,255,0.04);
    z-index: 100;
  }

  .brand { display: flex; gap: 14px; align-items: center; }
  
  .logo {
    width: 44px; height: 44px; border-radius: 12px;
    background: var(--accent-gradient);
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 0 25px var(--primary-glow);
    transition: transform 0.3s var(--ease-elastic);
  }
  .logo:hover { transform: scale(1.05) rotate(3deg); }
  .logoEmoji { font-size: 22px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); }

  h1 { font-size: 19px; font-weight: 700; letter-spacing: -0.01em; margin: 0; }
  .hint { font-size: 12px; color: var(--muted); font-weight: 500; }

  /* BOTONES */
  .controls { display: flex; gap: 10px; align-items: center; }
  
  .btn {
    background: rgba(255,255,255,0.03);
    color: var(--text-main);
    border: var(--glass-border);
    padding: 9px 16px;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 600;
    font-size: 13px;
    transition: all 0.2s ease;
    display: inline-flex; align-items: center; justify-content: center; gap: 8px;
    position: relative; overflow: hidden;
  }
  .btn:hover { background: rgba(255,255,255,0.07); transform: translateY(-1px); border-color: rgba(255,255,255,0.1); }
  .btn:active { transform: translateY(1px) scale(0.98); }

  .btn.primary {
    background: var(--accent-gradient);
    color: #020617;
    border: none;
    box-shadow: 0 4px 15px rgba(45, 212, 191, 0.25);
  }
  .btn.primary:hover { box-shadow: 0 6px 20px rgba(45, 212, 191, 0.4); opacity: 0.95; }
  
  .btn.ghost { background: transparent; border-color: transparent; color: var(--muted); }
  .btn.ghost:hover { color: #fff; background: rgba(255,255,255,0.03); }
  
  .btn.danger { background: rgba(244, 63, 94, 0.1); color: #fda4af; border: 1px solid rgba(244, 63, 94, 0.2); }
  .btn.danger:hover { background: rgba(244, 63, 94, 0.2); border-color: rgba(244, 63, 94, 0.4); }

  .chip {
    padding: 6px 12px; border-radius: 20px;
    background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05);
    font-size: 12px; color: var(--muted); display: flex; align-items: center;
  }

  /* AREA PRINCIPAL */
  main { padding: 32px 24px; max-width: 1200px; margin: 0 auto; }
  
  .topbar { display: flex; flex-wrap: wrap; gap: 16px; align-items: center; margin-bottom: 24px; }
  .stats { color: var(--muted); font-size: 13px; font-weight: 500; letter-spacing: 0.02em; }
  
  .search {
    padding: 12px 18px; border-radius: 12px;
    background: rgba(0,0,0,0.25); border: 1px solid rgba(255,255,255,0.08);
    color: #fff; width: 300px; font-family: inherit; font-size: 14px;
    transition: all 0.2s;
  }
  .search:focus {
    background: rgba(0,0,0,0.4); border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(45, 212, 191, 0.1);
  }

  /* BARRA DE SELECCION */
  #selectionBar {
    display: none; align-items: center; gap: 12px; margin-bottom: 24px;
    background: linear-gradient(90deg, rgba(45, 212, 191, 0.05) 0%, transparent 100%);
    border: 1px solid rgba(45, 212, 191, 0.15); border-left: 3px solid var(--primary);
    padding: 12px 20px; border-radius: 12px;
    animation: slideDown 0.3s var(--ease-elastic);
  }
  @keyframes slideDown { from { transform: translateY(-10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  
  #selectionBar .count { color: var(--primary); font-weight: 700; font-size: 15px; margin-right: 8px; }
  .selectAllBtn { 
    background: transparent; color: var(--text-main); border: 1px solid rgba(255,255,255,0.15); 
    padding: 6px 14px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 500;
  }

  /* GRID DE TARJETAS */
  .templates {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 20px; padding-bottom: 40px;
  }

  /* DISE√ëO DE TARJETA */
  .card {
    position: relative;
    background: var(--card-bg);
    backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
    border: 1px solid var(--card-border);
    border-radius: 18px;
    padding: 20px;
    display: flex; flex-direction: column; gap: 12px;
    min-height: 180px;
    transition: transform var(--trans-med), box-shadow var(--trans-med), border-color 0.2s;
    will-change: transform; overflow: hidden;
  }
  /* Brillo superior sutil */
  .card::after {
    content: ''; position: absolute; inset: 0; pointer-events: none;
    background: radial-gradient(800px circle at var(--mouse-x, 50%) var(--mouse-y, 0), rgba(255,255,255,0.04), transparent 40%);
    opacity: 0; transition: opacity 0.4s;
  }
  .card:hover::after { opacity: 1; }

  .card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 35px rgba(0,0,0,0.3), 0 0 0 1px rgba(255,255,255,0.08);
    background: rgba(30, 30, 35, 0.75);
    z-index: 5;
  }

  .card.selected {
    border-color: var(--primary);
    background: rgba(45, 212, 191, 0.04);
    box-shadow: 0 0 0 1px var(--primary);
  }
  
  .card.active {
    border-color: rgba(45, 212, 191, 0.4);
    box-shadow: 0 10px 40px rgba(0,0,0,0.4);
  }
  
  /* Estado BLOQUEADO */
  .card.locked {
    border-color: rgba(251, 191, 36, 0.2); /* Borde dorado sutil */
  }
  .card.locked textarea, .card.locked input.title {
    opacity: 0.7;
    cursor: default; /* Cursor normal, no de texto */
  }
  /* Indicador visual de inputs bloqueados */
  .card.locked textarea:focus, .card.locked input.title:focus {
    box-shadow: none; border-color: transparent;
  }

  /* Animaciones */
  .card.slide-in { animation: smoothEntry 0.5s var(--ease-elastic); }
  @keyframes smoothEntry { 0% { opacity: 0; transform: translateY(30px) scale(0.96); } 100% { opacity: 1; transform: translateY(0) scale(1); } }
  .card.removing { transform: scale(0.9) translateY(10px); opacity: 0; filter: blur(4px); transition: all 0.35s ease; }
  
  /* Animaci√≥n para nuevo item (restaurado) */
  .card.new-item { animation: highlightFlash 0.8s ease; }
  @keyframes highlightFlash { 0% { box-shadow: 0 0 0 2px var(--primary); background: rgba(45,212,191,0.1); } 100% { box-shadow: 0 0 0 0 transparent; background: var(--card-bg); } }
  
  .pre-push { transform: translateY(60px); opacity: 0; transition: none; }

  /* Inputs de Tarjeta */
  .row { display: flex; gap: 12px; align-items: center; margin-bottom: 6px; }
  
  input.title {
    background: transparent; border: none; color: #fff;
    font-size: 16px; font-weight: 600; flex: 1; padding: 4px 0;
    border-bottom: 1px dashed transparent; transition: 0.2s;
  }
  input.title:focus { border-bottom-color: var(--primary); }
  input.title[readonly] { border-bottom: 1px solid transparent; } /* Sin linea punteada al bloquear */
  input.title::placeholder { color: rgba(255,255,255,0.2); font-weight: 400; }

  textarea {
    background: rgba(0,0,0,0.2);
    border: 1px solid rgba(255,255,255,0.04);
    color: #cbd5e1;
    padding: 14px;
    border-radius: 10px;
    resize: none;
    min-height: 100px;
    font-family: 'Inter', sans-serif; font-size: 14px; line-height: 1.6;
    transition: all 0.2s;
  }
  textarea:focus { background: rgba(0,0,0,0.35); border-color: rgba(255,255,255,0.12); }
  textarea[readonly] { background: rgba(0,0,0,0.1); border-color: transparent; }

  .meta { display: flex; justify-content: space-between; font-size: 11px; color: rgba(255,255,255,0.25); margin-top: 10px; font-family: monospace; }

  /* Acciones */
  .actions { display: flex; gap: 8px; flex-wrap: wrap; opacity: 0; transform: translateY(5px); transition: all 0.25s ease; }
  .card:hover .actions { opacity: 1; transform: translateY(0); }
  
  .small {
    padding: 5px 10px; border-radius: 6px; font-size: 11px; font-weight: 500;
    background: rgba(255,255,255,0.06); border: none; color: var(--muted);
    cursor: pointer; transition: all 0.2s;
  }
  .small:hover { background: rgba(255,255,255,0.12); color: #fff; }
  .small.danger:hover { background: var(--danger); color: white; }

  .side-actions { position: absolute; top: 16px; right: 16px; display: flex; flex-direction: column; gap: 8px; z-index: 10; }
  .iconBtn {
    width: 34px; height: 34px; border-radius: 8px;
    background: rgba(0,0,0,0.4); color: var(--muted); border: 1px solid rgba(255,255,255,0.05);
    display: flex; align-items: center; justify-content: center; cursor: pointer;
    transition: all 0.2s;
  }
  .iconBtn:hover { background: var(--primary); color: #000; transform: scale(1.1); box-shadow: 0 4px 12px rgba(45,212,191,0.25); }
  .iconBtn.btnLock:hover { background: var(--gold); } /* Color especial para el candado */

  .tpl-select {
    appearance: none; -webkit-appearance: none;
    width: 20px; height: 20px; border-radius: 6px;
    border: 1px solid rgba(255,255,255,0.2); background: transparent;
    cursor: pointer; position: relative; transition: all 0.2s; display: grid; place-content: center;
  }
  .tpl-select:checked { background: var(--primary); border-color: var(--primary); }
  .tpl-select:checked::after { content: '‚úî'; font-size: 12px; color: #000; font-weight: bold; }

  /* MODAL */
  .modal-backdrop {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.7); backdrop-filter: blur(10px);
    display: flex; align-items: center; justify-content: center; z-index: 200;
    animation: fadeIn 0.3s ease;
  }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

  .modal {
    background: #101014; width: 94%; max-width: 550px;
    border-radius: 24px; padding: 28px;
    border: 1px solid rgba(255,255,255,0.08);
    box-shadow: 0 30px 60px -15px rgba(0, 0, 0, 0.8);
    position: relative; overflow: hidden;
  }
  .modal.animate-bounce { animation: modalUp 0.4s var(--ease-elastic); }
  @keyframes modalUp { 0% { transform: translateY(40px) scale(0.95); opacity: 0; } 100% { transform: translateY(0) scale(1); opacity: 1; } }
  .modal .accentBar { position: absolute; top: 0; left: 0; right: 0; height: 4px; background: var(--accent-gradient); }

  /* Estilos espec√≠ficos para √≠tems de la estanter√≠a */
  .shelf-item {
    margin-bottom: 12px;
    padding: 16px;
    border-radius: 12px;
    background: rgba(255,255,255,0.02);
    border: 1px solid rgba(255,255,255,0.04);
    transition: 0.2s;
  }
  .shelf-item:hover { background: rgba(255,255,255,0.04); border-color: rgba(255,255,255,0.08); }
  .shelf-content { font-size: 13px; color: var(--muted); margin: 8px 0 12px 0; line-height: 1.5; }

  /* Input group */
  .input-with-toggle { position: relative; margin-bottom: 12px; }
  .input-with-toggle input, .modal input {
    width: 100%; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1);
    padding: 12px; border-radius: 10px; color: #fff; margin-bottom: 8px;
    transition: 0.2s;
  }
  .input-with-toggle input:focus, .modal input:focus { border-color: var(--primary); background: rgba(0,0,0,0.5); }
  .input-with-toggle button { position: absolute; right: 10px; top: 8px; background: transparent; border: none; cursor: pointer; opacity: 0.6; }

  /* TOAST */
  .toast {
    position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(20px);
    background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(12px);
    border: 1px solid rgba(255,255,255,0.1);
    color: var(--primary); padding: 12px 24px; border-radius: 30px;
    box-shadow: 0 15px 40px rgba(0,0,0,0.6); font-weight: 600; font-size: 14px;
    opacity: 0; transition: all 0.4s var(--ease-elastic); z-index: 300; pointer-events: none;
    display: flex; align-items: center; gap: 8px;
  }
  .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

  /* Empty state */
  .empty {
    text-align: center; padding: 60px 20px; color: var(--muted);
    border: 2px dashed rgba(255,255,255,0.05); border-radius: 20px; margin-top: 20px;
    background: rgba(255,255,255,0.01);
  }

  /* Animaciones Extras */
  .pin-bounce { animation: pinPop 0.5s var(--ease-elastic); }
  @keyframes pinPop { 0% { transform: scale(1); } 50% { transform: scale(1.4); } 100% { transform: scale(1); } }
  .flash { animation: flashGlow 0.4s ease; }
  @keyframes flashGlow { 0% { box-shadow: 0 0 0 0 var(--primary); } 100% { box-shadow: 0 0 0 10px transparent; } }

  footer { text-align: center; color: rgba(255,255,255,0.15); font-size: 11px; margin-top: 60px; }

  /* Responsive */
  @media (max-width: 880px) {
    .card .actions { display: none; }
    .side-actions { display: flex; }
  }
  @media (min-width: 881px) { .side-actions { display: none; } }
  @media (max-width: 640px) {
    header { flex-direction: column; gap: 16px; align-items: flex-start; padding: 20px; }
    .controls { width: 100%; overflow-x: auto; padding-bottom: 4px; -webkit-overflow-scrolling: touch; }
    .templates { grid-template-columns: 1fr; }
    .search { width: 100%; }
    .topbar { flex-direction: column; align-items: stretch; }
  }
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo" id="logoEl" aria-hidden>
      <span class="logoEmoji" aria-hidden>üê´</span>
    </div>
    <div>
      <h1>PlantillaBox</h1>
      <div class="hint">Tus respuestas r√°pidas, con estilo.</div>
    </div>
  </div>

  <div class="controls">
    <div class="chip" id="currentUser"><span id="userDot" style="width:8px;height:8px;border-radius:99px;background:var(--primary);display:inline-block;margin-right:8px;box-shadow:0 0 8px var(--primary)"></span><span id="currentUserText">Invitado</span></div>
    <div style="display:flex;gap:8px;align-items:center">
      <button class="btn" id="btnShelf" title="Estanter√≠a">üìÅ Estanter√≠a</button>
      <button class="btn" id="btnExport">Exportar</button>
      <button class="btn" id="btnImport">Importar</button>
      <button class="btn primary" id="btnNew">+ Nueva</button>
      <button class="btn ghost" id="btnLogin">Entrar</button>
      <button class="btn ghost" id="btnLogout" style="display:none">Salir</button>
    </div>
  </div>
</header>

<main>
  <div class="topbar">
    <div class="stats" id="stats">0 plantillas</div>
    <div style="flex:1"></div>
    <input class="search" id="searchInput" placeholder="Buscar ideas..." />
  </div>

  <div id="selectionBar">
    <span class="count"><span id="selectedCount">0</span></span>
    <button id="selectAllBtn" class="selectAllBtn">Seleccionar todo</button>
    <div style="flex:1"></div>
    <button id="shelfSelectedBtn" class="btn small">Archivar</button>
    <button id="delSelectedBtn" class="btn small danger">Eliminar</button>
    <button id="clearSelectionBtn" class="btn small">Cancelar</button>
  </div>

  <section class="templates" id="templatesContainer"></section>
  <div id="emptyState" class="empty" style="display:none">
    <div style="font-size: 48px; margin-bottom: 16px; opacity: 0.4;">‚ú®</div>
    <div style="font-size: 16px; font-weight: 500;">No tienes plantillas a√∫n.</div>
    <div style="font-size: 13px; margin-top: 8px;">Haz clic en <strong>+ Nueva</strong> para empezar a crear.</div>
  </div>
</main>

<footer>
  PlantillaBox ‚Äî Almacenamiento local seguro y privado.
  <span id="footerInfo"></span>
</footer>

<div id="modalRoot" style="display:none"></div>
<div id="toastRoot" style="display:none"></div>

<script>
(() => {
  const APP_PREFIX = 'plantillabox';
  const USERS_KEY = APP_PREFIX + '_users_obj';
  const CURRENT_KEY = APP_PREFIX + '_current';
  const GUEST_KEY = APP_PREFIX + '_guest_session';
  const SHELF_KEY = (u) => APP_PREFIX + '_shelf_' + u;
  const TEMPL_KEY = (user) => APP_PREFIX + '_tpls_' + user;

  // DOM
  const templatesContainer = document.getElementById('templatesContainer');
  const stats = document.getElementById('stats');
  const emptyState = document.getElementById('emptyState');
  const btnNew = document.getElementById('btnNew');
  const btnLogin = document.getElementById('btnLogin');
  const btnExport = document.getElementById('btnExport');
  const btnImport = document.getElementById('btnImport');
  const btnShelf = document.getElementById('btnShelf');
  const btnLogout = document.getElementById('btnLogout');
  const searchInput = document.getElementById('searchInput');
  const modalRoot = document.getElementById('modalRoot');
  const toastRoot = document.getElementById('toastRoot');
  const currentUserText = document.getElementById('currentUserText');
  const userDot = document.getElementById('userDot');
  const footerInfo = document.getElementById('footerInfo');

  // selection bar elements
  const selectionBar = document.getElementById('selectionBar');
  const selectedCountEl = document.getElementById('selectedCount');
  const selectAllBtn = document.getElementById('selectAllBtn');
  const shelfSelectedBtn = document.getElementById('shelfSelectedBtn');
  const delSelectedBtn = document.getElementById('delSelectedBtn');
  const clearSelectionBtn = document.getElementById('clearSelectionBtn');
  // state
  let user = sessionStorage.getItem(CURRENT_KEY) || 'guest';
  if (!sessionStorage.getItem(CURRENT_KEY)) sessionStorage.setItem(CURRENT_KEY, 'guest');
  let templates = loadTemplatesFor(user);
  let shelf = loadShelfFor(user);
  let activeCardId = null;
  const selectedIds = new Set();
  function generateId() { return 'tpl_' + Math.random().toString(36).slice(2,9); }

  // initial UI
  updateUserUI();
  reorderPinned();
  render();
  // events
  btnNew.addEventListener('click', () => { btnNew.classList.add('pressed'); setTimeout(()=>btnNew.classList.remove('pressed'),160); addTemplate(); });
  btnLogin.addEventListener('click', openAuthModal);
  btnExport.addEventListener('click', exportJSON);
  btnImport.addEventListener('click', openImportModal);
  btnShelf.addEventListener('click', openShelfModal);
  btnLogout.addEventListener('click', () => {
    openModal({
      title: 'Cerrar sesi√≥n',
      body: `<p>¬øDeseas cerrar la sesi√≥n actual?</p>`,
      cancelText: 'Cancelar',
      confirmText: 'Cerrar sesi√≥n',
      onConfirm: () => {
        sessionStorage.setItem(CURRENT_KEY, 'guest');
        user = 'guest';
        templates = loadTemplatesFor(user);
        shelf = loadShelfFor(user);
        updateUserUI();
        render();
        showToast('Sesi√≥n cerrada');
      }
    });
  });
  searchInput.addEventListener('input', render);

  // selection bar events
  selectAllBtn.addEventListener('click', toggleSelectAllVisible);
  shelfSelectedBtn.addEventListener('click', () => { handleShelfSelected(); });
  delSelectedBtn.addEventListener('click', () => { handleDeleteSelected(); });
  clearSelectionBtn.addEventListener('click', () => { clearSelection(); });
  // allow drop to shelf
  btnShelf.addEventListener('dragover', (e) => { e.preventDefault(); btnShelf.classList.add('pressed'); });
  btnShelf.addEventListener('dragleave', () => { btnShelf.classList.remove('pressed'); });
  btnShelf.addEventListener('drop', (e) => {
    e.preventDefault();
    btnShelf.classList.remove('pressed');
    const idDropped = e.dataTransfer.getData('text/plain');
    if (!idDropped) return;
    const idx = templates.findIndex(t=> t.id === idDropped);
    if (idx === -1) return;
    const item = templates.splice(idx,1)[0];
    shelf.unshift(item);
    saveShelf(); saveTemplates(); render(); showToast('Guardada en estanter√≠a');
  });
  // pressed feedback
  document.addEventListener('pointerdown', (e) => {
    const el = e.target.closest('.btn, button, .iconBtn');
    if (!el) return;
    el.classList.add('pressed');
    setTimeout(()=> el.classList.remove('pressed'), 160);
  });
  
  // Storage & Logic
  function getUsersObj(){ const s = localStorage.getItem(USERS_KEY); try{ return s ? JSON.parse(s) : {}; }catch(e){ return {}; } }
  function saveUsersObj(o){ try{ localStorage.setItem(USERS_KEY, JSON.stringify(o)); }catch(e){ console.warn('Err save users', e); } }
  function loadTemplatesFor(u){ if (u === 'guest'){ const s = sessionStorage.getItem(GUEST_KEY); return s ? JSON.parse(s) : []; } const s = localStorage.getItem(TEMPL_KEY(u)); try{ return s ? JSON.parse(s) : []; } catch(e){ return []; } }
  function saveTemplates(){ if (user === 'guest') sessionStorage.setItem(GUEST_KEY, JSON.stringify(templates)); else localStorage.setItem(TEMPL_KEY(user), JSON.stringify(templates)); updateStats(); }
  function loadShelfFor(u){ if (u === 'guest'){ const s = sessionStorage.getItem(SHELF_KEY('guest')); return s ? JSON.parse(s) : []; } const s = localStorage.getItem(SHELF_KEY(u)); try{ return s ? JSON.parse(s) : []; } catch(e){ return []; } }
  function saveShelf(){ if (user === 'guest') sessionStorage.setItem(SHELF_KEY('guest'), JSON.stringify(shelf)); else localStorage.setItem(SHELF_KEY(user), JSON.stringify(shelf)); }

  async function hashPassword(password){
    if (!password) return '';
    if (window.crypto && crypto.subtle && crypto.subtle.digest){
      const enc = new TextEncoder(); const data = enc.encode(password);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      return Array.from(new Uint8Array(hashBuffer)).map(b=>b.toString(16).padStart(2,'0')).join('');
    }
    let h=0; for (let i=0;i<password.length;i++) h=(h*31+password.charCodeAt(i))>>>0;
    let hex=''; for (let i=0;i<8;i++) hex += ('00000000'+((h ^ (i*2654435761))>>>0).toString(16)).slice(-8); return hex;
  }

  function updateUserUI(){ currentUserText.textContent = (user === 'guest') ? 'Invitado' : user;
  footerInfo.textContent = (user === 'guest') ? 'Modo invitado (no persistente al cerrar).' : 'Sesi√≥n guardada en este navegador.';
  if (user === 'guest'){ userDot.style.opacity = '0.6'; if (window.logoEl) logoEl.classList.remove('logoStrong'); btnLogout.style.display = 'none'; } else { userDot.style.opacity = '1';
  if (window.logoEl) logoEl.classList.add('logoStrong'); btnLogout.style.display = 'inline-flex'; } }
  function updateStats(){ stats.textContent = templates.length + (templates.length === 1 ? ' plantilla' : ' plantillas');
  emptyState.style.display = templates.length ? 'none' : 'block'; }
  function id(){ return generateId(); }

  async function robustCopy(text) {
    if (!text) { showToast('Nada para copiar'); return false; }
    try {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        await navigator.clipboard.writeText(text);
        showToast('Copiado al portapapeles');
        return true;
      }
    } catch (e) {}
    try {
      const ta = document.createElement('textarea');
      ta.value = text;
      ta.style.position = 'fixed'; ta.style.left = '-9999px';
      document.body.appendChild(ta); ta.select(); ta.setSelectionRange(0, ta.value.length);
      const ok = document.execCommand('copy'); document.body.removeChild(ta);
      if (ok) { showToast('Copiado (fallback)'); return true; }
    } catch (err) {}
    showToast('No se pudo copiar'); return false;
  }

  function animatePinToTop(cardEl) {
    return new Promise((resolve) => {
      try {
        const rect = cardEl.getBoundingClientRect();
        const targetRect = templatesContainer.getBoundingClientRect();
        const destX = (targetRect.left + 12) - rect.left;
        const destY = (targetRect.top + 12) - rect.top;
        const clone = cardEl.cloneNode(true);
        clone.style.position = 'fixed'; clone.style.left = rect.left + 'px'; clone.style.top = rect.top + 'px';
        clone.style.width = rect.width + 'px'; clone.style.margin = '0'; clone.style.zIndex = 9999; clone.style.pointerEvents = 'none';
        clone.style.transition = 'transform 520ms cubic-bezier(.2,.9,.3,1), opacity 520ms ease';
        document.body.appendChild(clone);
        cardEl.style.transition = 'opacity 180ms ease'; cardEl.style.opacity = '0.28';
        requestAnimationFrame(() => {
          clone.style.transform = `translate(${destX}px, ${destY}px) scale(.95) rotate(-2deg)`;
          clone.style.opacity = '0.95';
        });
        setTimeout(() => {
          clone.style.opacity = '0';
          setTimeout(() => { if (clone.parentNode) clone.parentNode.removeChild(clone); cardEl.style.opacity = ''; resolve(); }, 140);
        }, 540);
      } catch (err) { resolve(); }
    });
  }

  async function togglePinById(id) {
    const idx = templates.findIndex(t => t.id === id);
    if (idx === -1) return;
    const willPin = !templates[idx].pinned;
    const cardEl = document.querySelector(`.card[data-id="${id}"]`);
    if (willPin && cardEl) {
      await animatePinToTop(cardEl).catch(()=>{});
      templates[idx].pinned = true; reorderPinned(); saveTemplates(); render();
      const newEl = document.querySelector(`.card[data-id="${id}"]`);
      if (newEl) { newEl.classList.add('pin-bounce'); setTimeout(()=> newEl.classList.remove('pin-bounce'), 520); }
      showToast('Anclada');
    } else {
      templates[idx].pinned = false; reorderPinned(); saveTemplates(); render(); showToast('Desanclada');
    }
  }

  // Nueva funci√≥n para bloqueo
  function toggleLockById(id) {
    const idx = templates.findIndex(t => t.id === id);
    if (idx === -1) return;
    const willLock = !templates[idx].locked;
    templates[idx].locked = willLock;
    saveTemplates(); render();
    showToast(willLock ? 'Plantilla bloqueada' : 'Plantilla desbloqueada');
  }

  function addTemplate(prefill = {title:'',content:''}, save=true){
    const existingCards = Array.from(document.querySelectorAll('.templates .card'));
    existingCards.forEach(c => c.classList.add('pre-push'));
    // Added locked: false
    const t = { id: id(), title: prefill.title || '', content: prefill.content || '', modified: Date.now(), pinned:false, locked:false };
    templates.unshift(t);
    if (save) saveTemplates();
    render();
    requestAnimationFrame(() => {
      document.querySelectorAll('.pre-push').forEach(c => { c.classList.remove('pre-push'); });
      const el = document.querySelector(`.card[data-id="${t.id}"]`);
      if (el){
        el.classList.add('slide-in'); setTimeout(()=> el.classList.remove('slide-in'), 520);
        const ta = el.querySelector('textarea');
        if(ta){ ta.focus(); setActiveCard(t.id); }
      }
    });
  }

  function setActiveCard(tid){
    if (!tid) return;
    if (activeCardId === tid) return;
    const prev = document.querySelector(`.card[data-id="${activeCardId}"]`);
    if (prev) prev.classList.remove('active','focus-outline');
    activeCardId = tid;
    const cur = document.querySelector(`.card[data-id="${activeCardId}"]`);
    if (cur) cur.classList.add('active','focus-outline');
    document.querySelectorAll('.card').forEach(c => { if (c.getAttribute('data-id') !== activeCardId) c.classList.remove('focus-outline'); });
  }

  function reorderPinned(){ const pinned = templates.filter(t=>t.pinned);
  const rest = templates.filter(t=>!t.pinned); templates = pinned.concat(rest); }

  function updateSelectionBar(){
    const count = selectedIds.size;
    if (count === 0) { selectionBar.style.display = 'none'; } else {
      selectionBar.style.display = 'flex';
      selectedCountEl.textContent = String(count) + ' seleccionada(s)';
      const visibleIds = Array.from(document.querySelectorAll('.card')).map(c => c.getAttribute('data-id'));
      const allVisibleSelected = visibleIds.every(id => selectedIds.has(id)) && visibleIds.length > 0;
      selectAllBtn.textContent = allVisibleSelected ? 'Deseleccionar todo' : 'Seleccionar todo';
    }
  }
  function clearSelection(){
    selectedIds.clear();
    document.querySelectorAll('.card').forEach(c => c.classList.remove('selected'));
    updateSelectionBar();
  }
  function toggleSelectAllVisible(){
    const visibleCards = Array.from(document.querySelectorAll('.card'));
    const visibleIds = visibleCards.map(c => c.getAttribute('data-id'));
    const allSelected = visibleIds.every(id => selectedIds.has(id)) && visibleIds.length>0;
    if (allSelected) { visibleIds.forEach(id => selectedIds.delete(id)); } else { visibleIds.forEach(id => selectedIds.add(id)); }
    visibleCards.forEach(c => {
      const idv = c.getAttribute('data-id');
      if (selectedIds.has(idv)) c.classList.add('selected'); else c.classList.remove('selected');
      const cb = c.querySelector('.tpl-select');
      if (cb) cb.checked = selectedIds.has(idv);
    });
    updateSelectionBar();
  }

  async function handleDeleteSelected(){
    if (selectedIds.size === 0) return;
    openModal({
      title: 'Eliminar plantillas',
      body: `<p>¬øEliminar ${selectedIds.size} plantilla(s)?</p>`,
      cancelText: 'Cancelar', confirmText: 'Eliminar',
      onConfirm: () => {
        Array.from(selectedIds).forEach(idv => {
          const el = document.querySelector(`.card[data-id="${idv}"]`);
          if (el) el.classList.add('removing');
        });
        setTimeout(()=> {
          templates = templates.filter(t => !selectedIds.has(t.id));
          saveTemplates(); clearSelection(); render(); showToast('Eliminado');
        }, 420);
      }
    });
  }

  function handleShelfSelected(){
    if (selectedIds.size === 0) return;
    const toMove = templates.filter(t => selectedIds.has(t.id));
    if (toMove.length === 0) return;
    shelf = toMove.concat(shelf);
    templates = templates.filter(t => !selectedIds.has(t.id));
    saveShelf(); saveTemplates(); clearSelection(); render(); showToast('Archivado');
  }

  function render(){
    templatesContainer.innerHTML = '';
    reorderPinned();
    const q = (searchInput.value || '').trim().toLowerCase();
    const filtered = templates.filter(t => !q || (t.title||'').toLowerCase().includes(q) || (t.content||'').toLowerCase().includes(q));
    filtered.forEach(t => {
      const checked = selectedIds.has(t.id);
      const isLocked = t.locked === true;
      const card = document.createElement('article');
      card.className = 'card';
      if (checked) card.classList.add('selected');
      if (isLocked) card.classList.add('locked'); // visual class
      card.setAttribute('data-id', t.id);
      card.setAttribute('draggable', 'true');
      
      // Conditionally add readonly
      const roAttr = isLocked ? 'readonly' : '';

      card.innerHTML = `
        <div class="row">
          <input type="checkbox" class="tpl-select" ${checked ? 'checked' : ''} aria-label="Seleccionar plantilla" />
          <input class="title" placeholder="T√≠tulo (opcional)" value="${escapeAttr(t.title||'')}" ${roAttr} />
          <div style="display:flex;gap:8px;align-items:center">
            <div class="side-actions" aria-hidden>
              <button class="iconBtn btnLock" title="${isLocked ? 'Desbloquear' : 'Bloquear'}">${isLocked ? 'üîí' : 'üîì'}</button>
              <button class="iconBtn btnPin" title="${t.pinned ? 'Desanclar' : 'Anclar'}">${t.pinned ? 'üìå' : 'üìç'}</button>
              <button class="iconBtn btnCopy" title="Copiar">üìã</button>
              <button class="iconBtn btnMore" title="M√°s">‚ãØ</button>
            </div>
            <div class="actions">
              <button class="small muted btnLockInline">${isLocked ? 'üîí Desbloquear' : 'üîì Bloquear'}</button>
              <button class="small muted btnPinInline">${t.pinned ? 'üìå' : 'üìç'}</button>
              <button class="small small-ghost btnCopyInline">Copiar</button>
              <button class="small btnDupInline">Duplicar</button>
              <button class="small muted btnShelfInline">üìÅ Archivar</button>
              <button class="small danger btnDelInline">Eliminar</button>
            </div>
          </div>
        </div>
        <textarea placeholder="Escribe tu plantilla aqu√≠..." spellcheck="false" ${roAttr}>${escapeHtml(t.content||'')}</textarea>
        <div class="meta"><span class="chars">${(t.content||'').length} caracteres</span><span class="modified">${t.modified ? 'Editado: ' + formatDate(t.modified) : ''}</span></div>
      `;
      templatesContainer.appendChild(card);
      card.addEventListener('dragstart', (ev) => { ev.dataTransfer.setData('text/plain', t.id); card.classList.add('dragging'); });
      card.addEventListener('dragend', () => card.classList.remove('dragging'));

      const inp = card.querySelector('.title');
      const ta = card.querySelector('textarea');
      const tplCheckbox = card.querySelector('.tpl-select');
      const btnPinEls = card.querySelectorAll('.btnPin, .btnPinInline');
      const btnLockEls = card.querySelectorAll('.btnLock, .btnLockInline'); // new
      const btnCopyEls = card.querySelectorAll('.btnCopy, .btnCopyInline');
      const btnMore = card.querySelector('.btnMore');
      const btnDup = card.querySelector('.btnDupInline');
      const btnDel = card.querySelector('.btnDelInline');
      const btnShelfInline = card.querySelector('.btnShelfInline');
      const charsEl = card.querySelector('.chars');
      const modEl = card.querySelector('.modified');

      tplCheckbox.addEventListener('change', (e) => {
        const isChecked = e.target.checked;
        if (isChecked) selectedIds.add(t.id); else selectedIds.delete(t.id);
        if (isChecked) card.classList.add('selected'); else card.classList.remove('selected');
        updateSelectionBar();
      });
      card.addEventListener('click', (ev) => {
        const ignore = ev.target.closest('input, textarea, button, .iconBtn, .moreMenu, .actions');
        if (ignore) return;
        const was = selectedIds.has(t.id);
        if (was) { selectedIds.delete(t.id); card.classList.remove('selected'); if (tplCheckbox) tplCheckbox.checked = false; }
        else { selectedIds.add(t.id); card.classList.add('selected'); if (tplCheckbox) tplCheckbox.checked = true; }
        updateSelectionBar();
      });

      function openMoreMenu(){
        closeAllMoreMenus();
        const menu = document.createElement('div'); menu.className = 'moreMenu';
        menu.style.cssText = "position:absolute; top:40px; right:10px; background:#18181b; border:1px solid rgba(255,255,255,0.1); border-radius:12px; padding:6px; z-index:50; min-width:160px; box-shadow:0 10px 40px rgba(0,0,0,0.5);";
        menu.innerHTML = `
          <button data-act="lock" style="width:100%;text-align:left;padding:10px;background:transparent;border:0;color:#94a3b8;cursor:pointer;display:flex;gap:8px">${t.locked ? 'üîì Desbloquear' : 'üîí Bloquear'}</button>
          <button data-act="copy" style="width:100%;text-align:left;padding:10px;background:transparent;border:0;color:#94a3b8;cursor:pointer;display:flex;gap:8px">üìã Copiar</button>
          <button data-act="dup" style="width:100%;text-align:left;padding:10px;background:transparent;border:0;color:#94a3b8;cursor:pointer;display:flex;gap:8px">‚ú≥Ô∏è Duplicar</button>
          <button data-act="pin" style="width:100%;text-align:left;padding:10px;background:transparent;border:0;color:#94a3b8;cursor:pointer;display:flex;gap:8px">${t.pinned ? 'üìå Desanclar' : 'üìç Anclar'}</button>
          <button data-act="shelf" style="width:100%;text-align:left;padding:10px;background:transparent;border:0;color:#94a3b8;cursor:pointer;display:flex;gap:8px">üìÅ Archivar</button>
          <button data-act="del" style="width:100%;text-align:left;padding:10px;background:transparent;border:0;color:#ef4444;cursor:pointer;display:flex;gap:8px">üóëÔ∏è Eliminar</button>
        `;
        card.appendChild(menu);
        menu.querySelectorAll('button').forEach(b => {
          b.addEventListener('click', async () => {
            const a = b.getAttribute('data-act');
            if (a === 'lock') toggleLockById(t.id); // new
            if (a === 'copy') { b.classList.add('flash'); setTimeout(()=>b.classList.remove('flash'),460); await robustCopy(t.content||''); }
            if (a === 'dup') doDup();
            if (a === 'pin') togglePinById(t.id);
            if (a === 'shelf') doShelf();
            if (a === 'del') doDel();
            closeAllMoreMenus();
          });
          b.addEventListener('mouseenter', ()=> { b.style.color='#fff'; b.style.background='rgba(255,255,255,0.05)'; b.style.borderRadius='8px'; });
          b.addEventListener('mouseleave', ()=> { b.style.color = b.getAttribute('data-act')==='del' ? '#ef4444' : '#94a3b8'; b.style.background='transparent'; });
        });
        setTimeout(()=> document.addEventListener('pointerdown', outsideHandler));
        function outsideHandler(ev){ if (!menu.contains(ev.target)) { menu.remove(); document.removeEventListener('pointerdown', outsideHandler); } }
      }
      function closeAllMoreMenus(){ document.querySelectorAll('.moreMenu').forEach(m=>m.remove()); }

      async function doCopy(el){ if (el){ el.classList.add('flash'); setTimeout(()=> el.classList.remove('flash'), 460); } await robustCopy(t.content||''); }
      function doDup(){ addTemplate({title: t.title + ' (copia)', content: t.content}); showToast('Duplicada'); }
      function doShelf(){ shelf.unshift(Object.assign({}, t)); templates = templates.filter(x=>x.id !== t.id); saveShelf(); saveTemplates(); render(); showToast('Archivado'); }
      function doDel(){ confirmDelete(t.id); }
      function doPin(){ togglePinById(t.id); }
      function doLock(){ toggleLockById(t.id); } // new

      btnPinEls.forEach(el => el.addEventListener('click', () => { doPin(); }));
      btnLockEls.forEach(el => el.addEventListener('click', () => { doLock(); })); // new
      btnCopyEls.forEach(el => { el.addEventListener('click', async () => { el.classList.add('flash'); setTimeout(()=> el.classList.remove('flash'), 460); await robustCopy(t.content || ''); }); });
      if (btnDup) btnDup.addEventListener('click', doDup);
      if (btnDel) btnDel.addEventListener('click', doDel);
      if (btnShelfInline) btnShelfInline.addEventListener('click', doShelf);
      if (btnMore) btnMore.addEventListener('click', openMoreMenu);

      card.addEventListener('pointerdown', ()=> { setActiveCard(t.id); try{ if (navigator.vibrate) navigator.vibrate(8); } catch(e){} });
      // Only focus if not locked
      if (!isLocked) {
        inp.addEventListener('focus', ()=> setActiveCard(t.id));
        ta.addEventListener('focus', ()=> setActiveCard(t.id));
      }
      
      card.addEventListener('focusin', () => card.classList.add('focus-outline'));
      card.addEventListener('focusout', () => { if (card.getAttribute('data-id') !== activeCardId) card.classList.remove('focus-outline'); });
      
      inp.addEventListener('input', (e) => { if(isLocked) return; t.title = e.target.value; t.modified = Date.now(); saveTemplates(); if (modEl) modEl.textContent = 'Editado: ' + formatDate(t.modified); });
      ta.addEventListener('input', (e) => { if(isLocked) return; t.content = e.target.value; t.modified = Date.now(); saveTemplates(); if (charsEl) charsEl.textContent = (t.content||'').length + ' caracteres'; if (modEl) modEl.textContent = 'Editado: ' + formatDate(t.modified); });
      
      if (t.id === activeCardId) card.classList.add('active','focus-outline');
    });
    updateStats();
    updateSelectionBar();
  }

  function confirmDelete(tid){
    openModal({
      title: 'Eliminar plantilla',
      body: `<p style="margin:0 0 8px 0; color:var(--muted)">¬øEst√°s seguro? Esta acci√≥n no se puede deshacer.</p><div style="text-align:center;font-size:32px;opacity:0.8;margin:10px 0;">üóëÔ∏è</div>`,
      cancelText: 'Cancelar', confirmText: 'Eliminar', mode: 'register', animation: 'bounce',
      onConfirm: () => {
        const cardEl = document.querySelector(`.card[data-id="${tid}"]`);
        if (cardEl) {
          cardEl.classList.add('removing');
          const rect = cardEl.getBoundingClientRect();
          const trash = document.createElement('div'); trash.textContent = 'üóëÔ∏è';
          trash.style.cssText = `position:fixed; left:${rect.left + rect.width/2}px; top:${rect.top + rect.height/2}px; font-size:32px; z-index:9999; transition:transform 420ms ease, opacity 420ms;`;
          document.body.appendChild(trash);
          requestAnimationFrame(()=> { trash.style.transform = 'translateY(-140px) translateX(40px) rotate(30deg) scale(.6)'; trash.style.opacity = '0'; });
          setTimeout(()=> { if (trash.parentNode) trash.parentNode.removeChild(trash); }, 480);
          setTimeout(()=> { templates = templates.filter(x => x.id !== tid); saveTemplates(); render(); showToast('Eliminada'); }, 420);
        } else {
          templates = templates.filter(x => x.id !== tid); saveTemplates(); render(); showToast('Eliminada');
        }
      }
    });
  }

  function openModal({title='Atenci√≥n', body='', confirmText='Aceptar', cancelText='Cancelar', onConfirm=null, mode='neutral', animation=''}) {
    modalRoot.style.display = 'block';
    let buttonsHtml = '<div style="display:flex;gap:12px;justify-content:flex-end;margin-top:24px">';
    if (cancelText !== null) buttonsHtml += `<button class="btn ghost" id="modalCancel">${cancelText}</button>`;
    if (confirmText !== null) buttonsHtml += `<button class="btn ${confirmText==='Eliminar'?'danger':'primary'}" id="modalConfirm">${confirmText}</button>`;
    buttonsHtml += '</div>';
    modalRoot.innerHTML = `
      <div class="modal-backdrop" id="modalBackdrop">
        <div class="modal ${animation === 'bounce' ? 'animate-bounce' : ''} mode-${mode}" role="dialog" aria-modal="true">
          <h3 style="margin-top:0;font-size:20px;letter-spacing:-0.01em">${title}</h3>
          <div style="margin:12px 0;font-size:14px;line-height:1.6">${body}</div>
          ${buttonsHtml}
          <div class="accentBar"></div>
        </div>
      </div>
    `;
    const cancelEl = document.getElementById('modalCancel');
    const confirmEl = document.getElementById('modalConfirm');
    if (cancelEl) cancelEl.addEventListener('click', closeModal);
    document.getElementById('modalBackdrop').addEventListener('click', (e) => { if (e.target.id === 'modalBackdrop') closeModal(); });
    if (confirmEl) confirmEl.addEventListener('click', () => { if (onConfirm) onConfirm(); closeModal(); });
  }
  function closeModal(){ modalRoot.style.display = 'none'; modalRoot.innerHTML = ''; }

  function openAuthModal(){
    const users = Object.keys(getUsersObj());
    const usersListHtml = users.length ? `<div class="hint" style="margin-bottom:12px">Usuarios detectados: ${users.join(', ')}</div>` : '';
    modalRoot.style.display = 'block';
    modalRoot.innerHTML = `
      <div class="modal-backdrop" id="modalBackdrop">
        <div class="modal animate-bounce mode-neutral" id="authModal" role="dialog" aria-modal="true">
          <h3 style="margin-top:0;font-size:20px">Cuenta</h3>
          ${usersListHtml}
          <div style="display:flex; background:rgba(255,255,255,0.04); padding:4px; border-radius:12px; margin-bottom:20px;">
            <button class="btn ghost" id="tabLogin" style="flex:1;border:0">Ingresar</button>
            <button class="btn ghost" id="tabRegister" style="flex:1;border:0">Registrar</button>
            <button class="btn ghost" id="tabGuest" style="flex:1;border:0">Invitado</button>
          </div>
          <div id="authBody" style="min-height:160px"></div>
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:20px"><button class="btn ghost" id="modalClose">Cerrar</button></div>
          <div class="accentBar"></div>
        </div>
      </div>
    `;
    const authBody = document.getElementById('authBody');
    const tabLogin = document.getElementById('tabLogin');
    const tabRegister = document.getElementById('tabRegister');
    const tabGuest = document.getElementById('tabGuest');
    
    function highlightTab(selected){
      [tabLogin, tabRegister, tabGuest].forEach(t => { t.style.background='transparent'; t.style.color='var(--muted)'; t.style.boxShadow='none'; });
      const sel = selected==='login'?tabLogin:(selected==='register'?tabRegister:tabGuest);
      sel.style.background='rgba(255,255,255,0.1)'; sel.style.color='#fff'; sel.style.boxShadow='0 2px 8px rgba(0,0,0,0.2)';
    }

    document.getElementById('modalClose').addEventListener('click', closeModal);
    tabLogin.addEventListener('click', () => { renderLogin(); highlightTab('login'); });
    tabRegister.addEventListener('click', () => { renderRegister(); highlightTab('register'); });
    tabGuest.addEventListener('click', () => { renderGuest(); highlightTab('guest'); });
    renderLogin(); highlightTab('login');

    function renderLogin(){
      authBody.innerHTML = `
        <div style="display:flex;flex-direction:column;gap:12px">
          <input id="loginUser" placeholder="Usuario" autocomplete="username"/>
          <div class="input-with-toggle">
            <input id="loginPass" type="password" placeholder="Contrase√±a" autocomplete="current-password"/>
            <button id="toggleLoginPass" title="Mostrar contrase√±a">üëÅÔ∏è</button>
          </div>
          <div style="display:flex;gap:12px;align-items:center;margin-top:8px">
            <button class="btn primary" id="doLogin" style="flex:1">Entrar</button>
            <button class="btn" id="useGuest">Invitado</button>
          </div>
          <div class="auth-note" style="font-size:12px;color:var(--muted);margin-top:10px">No uses email. Si no tienes cuenta, reg√≠strate.</div>
        </div>
      `;
      const toggle = document.getElementById('toggleLoginPass');
      toggle.addEventListener('click', () => {
        const p = document.getElementById('loginPass');
        if (p.type === 'password') { p.type = 'text'; toggle.textContent = 'üôà'; } else { p.type = 'password'; toggle.textContent = 'üëÅÔ∏è'; }
      });
      document.getElementById('doLogin').addEventListener('click', async ()=>{
        const name = (document.getElementById('loginUser').value||'').trim();
        const pass = document.getElementById('loginPass').value||'';
        if (!name || !pass) return alert('Escribe usuario y contrase√±a');
        const users = getUsersObj();
        if (!users[name]) return alert('Usuario no encontrado');
        const h = await hashPassword(pass);
        if (h !== users[name].hash) return alert('Contrase√±a incorrecta');
        sessionStorage.setItem(CURRENT_KEY, name);
        user = name; templates = loadTemplatesFor(user); shelf = loadShelfFor(user); updateUserUI(); render(); closeModal(); showToast('Sesi√≥n iniciada');
      });
      document.getElementById('useGuest').addEventListener('click', ()=>{ sessionStorage.setItem(CURRENT_KEY,'guest'); user='guest'; templates = loadTemplatesFor(user); shelf = loadShelfFor(user); updateUserUI(); render(); closeModal(); showToast('Invitado'); });
    }

    function renderRegister(){
      authBody.innerHTML = `
        <div style="display:flex;flex-direction:column;gap:12px">
          <input id="regUser" placeholder="Nombre de usuario (no email)"/>
          <div class="input-with-toggle"><input id="regPass" type="password" placeholder="Contrase√±a (m√≠n 6)"/><button id="toggleRegPass">üëÅÔ∏è</button></div>
          <div class="input-with-toggle"><input id="regPass2" type="password" placeholder="Confirmar contrase√±a"/><button id="toggleRegPass2">üëÅÔ∏è</button></div>
          <div style="display:flex;gap:8px;align-items:center;margin-top:8px"><button class="btn primary" id="doRegister" style="flex:1">Crear cuenta</button></div>
          <div class="auth-note" style="font-size:12px;color:var(--muted);margin-top:10px">Registro local y privado.</div>
        </div>
      `;
      document.getElementById('toggleRegPass').addEventListener('click', () => { const p = document.getElementById('regPass'); p.type = p.type === 'password' ? 'text' : 'password'; });
      document.getElementById('toggleRegPass2').addEventListener('click', () => { const p = document.getElementById('regPass2'); p.type = p.type === 'password' ? 'text' : 'password'; });
      document.getElementById('doRegister').addEventListener('click', async ()=>{
        const name = (document.getElementById('regUser').value||'').trim();
        const pass = document.getElementById('regPass').value||'';
        const pass2 = document.getElementById('regPass2').value||'';
        if (!name || !pass || !pass2) return alert('Completa todos los campos');
        if (/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(name)) return alert('No uses correo como usuario');
        if (pass.length < 6) return alert('Contrase√±a m√≠nima 6');
        if (pass !== pass2) return alert('Contrase√±as no coinciden');
        const users = getUsersObj();
        if (users[name]) return alert('Usuario en uso');
        const h = await hashPassword(pass);
        users[name] = { hash: h, createdAt: new Date().toISOString() };
        saveUsersObj(users);
        try {
          const userTemplates = Array.isArray(templates) && templates.length ? templates.map(x => ({ id: id(), title: x.title||'', content: x.content||'', modified: x.modified || Date.now(), pinned: !!x.pinned, locked:false })) : [];
          localStorage.setItem(TEMPL_KEY(name), JSON.stringify(userTemplates));
        } catch (err) { localStorage.setItem(TEMPL_KEY(name), JSON.stringify([])); }
        sessionStorage.setItem(CURRENT_KEY, name);
        user = name; templates = loadTemplatesFor(user); shelf = loadShelfFor(user); updateUserUI(); render(); closeModal(); showToast('Registrado');
      });
    }

    function renderGuest(){
      authBody.innerHTML = `
        <div style="display:flex;flex-direction:column;gap:12px">
          <div class="auth-note" style="padding:15px;background:rgba(255,255,255,0.05);border-radius:10px;font-size:14px;color:var(--text-main)">
          El modo invitado guarda tus plantillas solo temporalmente en esta pesta√±a. Se perder√°n al cerrar.
          </div>
          <div style="display:flex;gap:8px;margin-top:10px"><button class="btn primary" id="useGuestNow" style="width:100%">Entrar como Invitado</button></div>
        </div>
      `;
      document.getElementById('useGuestNow').addEventListener('click', ()=>{ sessionStorage.setItem(CURRENT_KEY,'guest'); user='guest'; templates = loadTemplatesFor(user); shelf = loadShelfFor(user); updateUserUI(); render(); closeModal(); showToast('Invitado'); });
    }
  }

  // Shelf modal (fixed restore)
  function openShelfModal(){
    renderShelfModal();
    function renderShelfModal(){
      const listHtml = shelf.length ?
      shelf.map(s => `
        <li class="shelf-item" data-id="${s.id}">
          <div style="font-weight:600;color:#fff">${escapeHtml(s.title||'(Sin t√≠tulo)')}</div>
          <div class="shelf-content">${escapeHtml((s.content||'').slice(0,180))}${(s.content||'').length>180?'‚Ä¶':''}</div>
          <div style="display:flex;gap:10px">
            <button class="btn small restore" style="background:rgba(45,212,191,0.1);color:var(--primary)">Restaurar</button> 
            <button class="btn small danger del">Eliminar</button>
          </div>
        </li>`).join('') : '<div class="hint" style="text-align:center;padding:30px">La estanter√≠a est√° vac√≠a.</div>';
      
      openModal({ title:'Estanter√≠a', body:`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><div class="hint">Archivados</div><button class="btn ghost small" id="shelfHome">Ir al inicio</button></div><div style="max-height:50vh;overflow-y:auto;padding-right:6px;margin-top:10px"><ul style="list-style:none;padding:0;margin:0">${listHtml}</ul></div>`, cancelText: null, confirmText:'Cerrar', onConfirm:null });
      
      setTimeout(()=> {
        const shelfHome = document.getElementById('shelfHome');
        if (shelfHome) shelfHome.addEventListener('click', ()=> { closeModal(); window.scrollTo({top:0, behavior:'smooth'}); });

        const modalRootEl = document.getElementById('modalRoot');
        modalRootEl.querySelectorAll('.restore').forEach(btn => {
          btn.addEventListener('click', (ev) => {
            const li = ev.target.closest('li'); if (!li) return;
            const itemId = li.getAttribute('data-id');
            const idx = shelf.findIndex(x => x.id === itemId);
            if (idx === -1) return;
            const item = shelf.splice(idx,1)[0];
            const restored = { id: id(), title: item.title, content: item.content, modified: Date.now(), pinned:false, locked:false };
            templates.unshift(restored); // Al inicio
            saveShelf(); saveTemplates(); 
            
            // FIX: Renderizado inmediato para que aparezca en el fondo
            render(); 

            li.parentNode.removeChild(li);
            showToast('Restaurada');
            
            // Scroll al nuevo elemento
            setTimeout(()=> {
              const el = document.querySelector(`.card[data-id="${restored.id}"]`);
              if (el) { el.classList.add('new-item'); setTimeout(()=> el.classList.remove('new-item'),600); el.scrollIntoView({behavior:'smooth', block:'center'}); setActiveCard(restored.id); }
            }, 100);
          });
        });
        modalRootEl.querySelectorAll('.del').forEach(btn => {
          btn.addEventListener('click', (ev) => {
            const li = ev.target.closest('li'); if (!li) return;
            const itemId = li.getAttribute('data-id');
            shelf = shelf.filter(x => x.id !== itemId);
            saveShelf();
            li.parentNode.removeChild(li);
            showToast('Eliminada definitivamente');
          });
        });
      }, 40);
    }
  }

  function exportJSON(){
    const exportData = { exportedAt: new Date().toISOString(), user: user, templates: templates, shelf: shelf };
    const blob = new Blob([JSON.stringify(exportData, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url;
    a.download = (user==='guest' ? 'plantillas-guest' : 'plantillas-' + user) + '.json'; a.click(); URL.revokeObjectURL(url); showToast('Exportado');
  }
  function openImportModal(){
    openModal({ title:'Importar JSON', body:`<input type="file" id="importFile" accept=".json"/><div class="hint">A√±adir o reemplazar plantillas.</div>`, cancelText:'Cerrar', confirmText:'Cerrar', onConfirm:null });
    setTimeout(()=> {
      const fi = document.getElementById('importFile'); if(!fi) return;
      fi.addEventListener('change', (e)=> {
        const f = e.target.files[0]; if(!f) return;
        const r = new FileReader();
        r.onload = (ev)=> {
          try {
            const obj = JSON.parse(ev.target.result);
            if (Array.isArray(obj.templates)) {
              openModal({ title:'Importar', body:'¬øC√≥mo quieres importar?', cancelText:'A√±adir al final', confirmText:'Reemplazar todo', onConfirm: ()=> {
                templates = obj.templates.map(x=>({id: id(), title:x.title||'', content:x.content||'', modified:Date.now(), pinned:false, locked:false}));
                if (Array.isArray(obj.shelf)) shelf = obj.shelf.map(x=>({id:id(), title:x.title||'', content:x.content||'', modified:Date.now()}));
                saveTemplates(); saveShelf(); render(); showToast('Reemplazado');
              }});
              setTimeout(()=> {
                const cancelBtn=document.querySelector('#modalCancel');
                if(cancelBtn) {
                  cancelBtn.addEventListener('click', ()=> {
                    const imported = obj.templates.map(x=>({id:id(),title:x.title||'',content:x.content||'',modified:Date.now(),pinned:false,locked:false}));
                    templates = imported.concat(templates);
                    if (Array.isArray(obj.shelf)) shelf = obj.shelf.map(x=>({id:id(),title:x.title||'',content:x.content||'',modified:Date.now()})).concat(shelf);
                    saveTemplates(); saveShelf(); render(); showToast('A√±adido');
                  }, {once:true});
                }
              }, 20);
            } else alert('JSON inv√°lido');
          } catch(err){ alert('Error: '+err.message); }
        };
        r.readAsText(f); closeModal();
      });
    }, 40);
  }

  let toastTimer=null;
  function showToast(txt){ toastRoot.style.display='block'; toastRoot.innerHTML = `<div class="toast show"><span>‚ú®</span> ${txt}</div>`; if(toastTimer) clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>{ toastRoot.style.display='none'; toastRoot.innerHTML=''; },2600); }

  function escapeHtml(s){ if (s==null) return ''; return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  function escapeAttr(s){ if (s==null) return ''; return s.replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;'); }
  function formatDate(ts){ try{ return new Date(ts).toLocaleDateString('es-ES', {day:'numeric', month:'short', hour:'2-digit', minute:'2-digit'}); }catch(e){return ''} }

  // expose
  window.PlantillaBox = { addTemplate, getState: ()=>({user, templates, shelf}) };
})();
</script>
</body>
</html>
